# Maintainer: David Runge <dvzrv@archlinux.org>
_pkgname=ambix
pkgname=ambix-o1
pkgname=(ambix-o1 ambix-o1-{lv2,standalone,vst})
pkgver=0.3.0
pkgrel=1
pkgdesc="Ambisonic plug-ins with variable order for use in Digital Audio Workstations"
arch=('x86_64' 'x86_64_v3')
url="https://github.com/kronihias/ambix"
conflicts=(ambix ambix-{lv2,standalone,vst})
replaces=(ambix ambix-{lv2,standalone,vst})
license=(GPL2)
makedepends=(
  alsa-lib
  cmake
  eigen
  fftw
  freeglut
  freetype2
  gcc-libs
  gendesk
  git
  glibc
  glu
  jack
  libglvnd
  liblo
  libsoxr
  libx11
  libxcursor
  libxext
  libxinerama
  vst2sdk
  webkit2gtk
  zita-convolver
)
checkdepends=(lv2lint)
source=(
  $url/archive/v$pkgver/${_pkgname}-v$pkgver.tar.gz
  JUCE-7.0.5.tar.gz
  # ${_pkgname}-0.3.0-lv2_plugin_uri.patch
)
sha512sums=('d57ecd19f33fed98f9a4579f74f411880e85b42f56c095d47406d4c6a387a90279b84261c687721f4d13541dd6e3e8e751ce94d46ae533fc97d856d1e3e343e5'
            '0f54752d8387d7cb5ad17360e6111cc4b89dc9c1565b64f8ef2379ef2afa1589041f7f92d6b11d56dbe1a5936a1db35ef5c8d97fd45cd30a0d3bce9ae85298ea')
b2sums=('44215ded9b0649089dcfbf83f510fb9f46f419498e03e463f187d077f34cab972b85890aa771a832f2797014b0dff9d320eab2c0e46790b28f209355b73a3091'
        '19c028f4c3c5d2cb8cfb2b3a9550ec84486a618c0fe454a51064cfbd74b7e25c4f372f1eebba94260a6d199ca08bf068869cd19ae422476e30c5c4abd231c81a')

_plugin_names=(
  ambix_binaural
  ambix_converter
  ambix_decoder
  ambix_directional_loudness
  ambix_encoder_i2
  ambix_encoder_i4
  ambix_encoder_i6
  ambix_encoder_i8
  ambix_encoder
  ambix_maxre
  ambix_mirror
  ambix_rotator
  ambix_rotator_z
  ambix_vmic
  ambix_warp
  ambix_widening
)

_standalone_names=(
  ambix_binaural
  ambix_converter
  ambix_decoder
  ambix_directional_loudness
  ambix_encoder
  ambix_mirror
  ambix_rotator
  ambix_vmic
)

prepare() {
  # set proper LV2 URIs:
  # https://github.com/kronihias/ambix/issues/27
  # patch -Np1 -d ${_pkgname}-$pkgver -i ../${_pkgname}-0.3.0-lv2_plugin_uri.patch

# fix for gcc >= 9.1.0
  # https://github.com/kronihias/ambix/issues/26
  # patch -Np1 -d ${_pkgname}-$pkgver -i ../${_pkgname}-0.2.10-gcc9.1.0.patch

  declare -A _descriptions=(
    ['ambix_binaural']="Listen to Ambisonics with Headphones"
    ['ambix_converter']="Convert between Ambisonics Formats"
    ['ambix_decoder']="Playback Ambisonics with Loudspeakers"
    ['ambix_directional_loudness']="Amplify, Attenuate or Filter Out Certain Parts of the Spherical Soundfield"
    ['ambix_encoder']="Encode Audio for Ambisonics"
    ['ambix_mirror']="Adjust Symmetric Components in Ambisonics Streams"
    ['ambix_rotator']="Rotate Sounds for Ambisonics"
    ['ambix_vmic']="Virtual Microphone: Select part of the Soundfield"
  )
  declare -A _generic=(
    ['ambix_binaural']="Binaural Decoder"
    ['ambix_converter']="Ambisonics Formats Converter"
    ['ambix_decoder']="Single-band Decoded Ambisonics"
    ['ambix_directional_loudness']="Spherical Soundfield Amplifier"
    ['ambix_encoder']="Ambisonics Panning"
    ['ambix_mirror']="Soundfield Mirroring"
    ['ambix_rotator']="Ambisonics Sounds Rotator"
    ['ambix_vmic']="Ambisonics Virtual Microphone"
  )
  for _standalone in "${_standalone_names[@]}"; do
    gendesk -n \
            --pkgname "${_standalone}_o1" \
            --name "${_standalone}_o1" \
            --pkgdesc "${_description[${_standalone}]}" \
            --genericname "${_generic[${_standalone}]}" \
            --categories "AudioVideo;Audio"
  done

  mv JUCE/ ${_pkgname}-${pkgver}/

}

build() {
  local _plugin_dir _plugin
  local cmake_options=(
    -B build
    -D BUILD_LV2=ON
    -D CMAKE_BUILD_TYPE=Release
    -D CMAKE_INSTALL_PREFIX=/usr
    -D OpenGL_GL_PREFERENCE=GLVND
    -D WITH_ZITA_CONVOLVER=ON
    -D VST2SDKPATH=/usr/include/vst36
    -D AMBI_ORDER=1 \
    -S ${_pkgname}-$pkgver
    -W no-dev
  )

  cmake "${cmake_options[@]}"
  cmake --build build --verbose
  make -C ${_pkgname}-$pkgver/lv2-ttl-generator
  for _plugin_dir in build/_bin/lv2/*.lv2; do
    (
      cd $_plugin_dir
      for _plugin in *.so; do
        "$srcdir/${_pkgname}-$pkgver/lv2-ttl-generator/lv2_ttl_generator" "./$_plugin"
      done
    )
  done
}

check() {
  for _plugin in "${_plugin_names[@]}"; do
    lv2lint -I build/_bin/lv2/${_plugin}_o1.lv2/ "https://github.com/kronihias/ambix/${_plugin}_o1" || echo "Known to fail: https://github.com/kronihias/ambix/issues/29"
  done
}

package_ambix-o1() {
  depends=(
    $pkgbase-{lv2,standalone,vst}
  )
}

package_ambix-o1-lv2() {
  pkgdesc+=" - LV2 plugins"
  groups=(
    lv2-plugins
    pro-audio
  )
  depends=(
    fftw libfftw3f.so libfftw3f_threads.so
    freetype2 libfreetype.so
    gcc-libs
    glibc
    libglvnd
    libsoxr
    libx11
    libxext
    lv2-host
    zita-convolver libzita-convolver.so
  )

  for _plugin in "${_plugin_names[@]}"; do
    install -vDm 755 build/_bin/lv2/${_plugin}_o1.lv2/*.so -t "$pkgdir/usr/lib/lv2/${_plugin}_o1.lv2/"
    install -vDm 644 build/_bin/lv2/${_plugin}_o1.lv2/*.ttl -t "$pkgdir/usr/lib/lv2/${_plugin}_o1.lv2/"
  done
}

package_ambix-o1-standalone() {
  pkgdesc+=" - standalone"
  groups=(
    pro-audio
  )
  depends=(
    alsa-lib libasound.so
    fftw libfftw3f.so libfftw3f_threads.so
    freetype2 libfreetype.so
    gcc-libs
    glibc
    libglvnd
    libsoxr
    libx11
    libxext
    zita-convolver libzita-convolver.so
  )

  for _standalone in "${_standalone_names[@]}"; do
    install -vDm 755 build/_bin/standalone/${_standalone}_standalone_o1 "$pkgdir/usr/bin/${_standalone}_standalone_o1"
  done
  install -vDm 644 ./*.desktop -t "$pkgdir/usr/share/applications/"
}

package_ambix-o1-vst() {
  pkgdesc+=" - VST plugins"
  groups=(
    pro-audio
    vst-plugins
  )
  depends=(
    fftw libfftw3f.so libfftw3f_threads.so
    freetype2 libfreetype.so
    gcc-libs
    glibc
    libglvnd
    libsoxr
    libx11
    libxext
    vst-host
    zita-convolver libzita-convolver.so
  )

  for _plugin in "${_plugin_names[@]}"; do
    strip build/_bin/vst/${_plugin}_o1.so
    install -vDm 755 build/_bin/vst/${_plugin}_o1.so "$pkgdir/usr/lib/vst/${_plugin}_o1.so"
  done
}
